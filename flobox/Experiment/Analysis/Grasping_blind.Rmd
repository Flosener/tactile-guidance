---
title: "OptiVisT grasping analysis"
author: "Florian PÃ¤tzold, Ramon Zacharias"
date: "3/21/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

Import all necessary packages.

```{r}
library(dplyr)
library(ggplot2)
library(EnvStats)
library(outliers)
library(lme4)
library(lmerTest) # significance testing for linear mixed models
```

# Data preprocessing

Set working directory, load all the grasping data, clean it and combine it into one dataframe.

```{r}
# Set working directory to the folder containing the CSV files
setwd("data/blind")
# Get list of all CSV files for the grapsing task in the folder
file_list <- list.files(getwd(), pattern = "*grasping*")
# Create an empty data frame to store the combined data
combined_data <- data.frame()
# Create inverted %in% function
`%ni%` <- Negate(`%in%`)
# Loop through each CSV file
for (file in file_list) {
  # Read the CSV file into a data frame
  file_data <- read.csv(file, header = TRUE, sep = ",")
  
  # Extract the number from the filename and add as a new column
  number <- as.numeric(gsub("[^0-9]+", "", file))
  file_data$participant_id <- number
  
  # More than 3 rep trials for each block is unfeasible and must be wrong data saving
  # Then we only take the last 8 blocks
  if (length(file_data$location) > 8 * (9+3)) {
    file_data <- file_data[tail(which(file_data$time == "time"), n=1) + 1 : length(file_data$time), ]
    file_data <- file_data[complete.cases(file_data), ]
  }
  
  # Cast column types from factor to numeric/char
  file_data$time <- as.numeric(as.character(file_data$time))
  file_data$num_instructions <- as.numeric(as.character(file_data$num_instructions))
  file_data$location <- as.character(file_data$location)
  file_data$block <- as.numeric(as.character(file_data$block))
  
  # Assign the correct block number for repetition trials in the tactile condition of P 1-6
  transform(file_data, block = as.numeric(block))
  if (number <= 6 & file_data$condition[1] == "tactile") {
    for (i in 1:length(file_data$location)) {
      if (file_data$location[i] %ni% list(1,2,3,4,5,6,7,8,9,"location")) {
        file_data$block[i] <- file_data$block[i-1] # dtype of col is factor when it should be numeric
      }
    }
  }
  
  # Append the data to the combined data frame
  combined_data <- rbind(combined_data, file_data)
  
}

# Save the combined data frame as a CSV file
row.names(combined_data) <- NULL
write.csv(combined_data, "combined_blind.csv")
```

### Outlier detection

```{r}
# first block in each condition is training block
clean_data <- combined_data %>% filter(block != 1)

# Grubbs' test by condition
grubbs_results <- by(clean_data$time, clean_data$condition, grubbs.test)
print(grubbs_results)

# clean_data <- clean_data %>% filter(time < 10.0)
```

### Normality assumption check

```{r}
# Split the data by condition and drop fails
auditory_data <- clean_data %>% filter(condition == "auditory", success == "success")
tactile_data <- clean_data %>% filter(condition == "tactile", success == "success")

# Check for normality using histogram and normal probability plot for each condition
par(mfrow=c(2,2)) # create 2x2 plot grid

# Histogram and normal probability plot for auditory condition
hist(auditory_data$time, main="Histogram of Auditory Times", xlab="Times")
qqnorm(auditory_data$time, main="Normal Probability Plot of Auditory Times")
qqline(auditory_data$time)

# Histogram and normal probability plot for tactile condition
hist(tactile_data$time, main="Histogram of Tactile Times", xlab="Times")
qqnorm(tactile_data$time, main="Normal Probability Plot of Tactile Times")
qqline(tactile_data$time)

# Perform Shapiro-Wilk test for normality for each condition
shapiro.test(auditory_data$time)
shapiro.test(tactile_data$time)

# Perform Kolmogorov-Smirnov test for each condition (compares data to normal distribution pnorm)
ks.test(auditory_data$time, "pnorm", mean(auditory_data$time), sd(auditory_data$time))
ks.test(tactile_data$time, "pnorm", mean(tactile_data$time), sd(tactile_data$time))
```

The Shapiro-Wilk test (a,t: \*\*\*) suggests that the data was generated from a non-normal distribution --> we use non-parametric hypothesis tests --> Wilcoxon rank sum to compare unpaired data medians.

# Data visualiation and hypothesis testing

Calculate summary statistics, visualize aspects of the data and test the corresponding hypotheses.

```{r}
# Barplot: Mean trial times for each condition per participant
clean_data %>% filter(success == "success") %>% group_by(participant_id, condition) %>% summarize(mean_time = mean(time)*1000)
clean_data %>% filter(success == "success") %>% group_by(participant_id, condition) %>% summarize(mean_time = mean(time)*1000) %>% 
ggplot(aes(x = factor(participant_id), y = mean_time, fill = condition)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Mean trial times for each participant per condition", 
    x = "Participant", 
    y = "Trial time (ms) \n",
    fill = "condition"
    ) +
  theme_linedraw() + 
  theme(plot.title = element_text(face = "bold", hjust = 0.5), 
    plot.subtitle = element_text(hjust = 0.5),
    legend.position = "right")
```

```{r}
# Bar plot: x = fail, exfail (grouped by condition), y = counts
clean_data %>% group_by(condition, success) %>% count() %>% filter(success != "success")
clean_data %>% group_by(condition, success) %>% count() %>% filter(success != "success") %>%
  ggplot(aes(x = condition, y = n, fill = success)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_text(aes(label = n), position = position_dodge(width = 1), vjust = 2, hjust=0.5) +
  scale_y_continuous(breaks = scales::pretty_breaks()) +
  labs(
    title = "Count of trials with false instruction or response", 
    x = NULL, 
    y = "Count \n",
    subtitle = "in auditory and tactile condition \n"
    ) +
  theme_linedraw() + 
  theme(plot.title = element_text(face = "bold", hjust = 0.5), 
    plot.subtitle = element_text(hjust = 0.5),
    legend.position = "right", legend.title = element_blank()) +
  scale_fill_discrete(labels = c("experimenter fail", "participant fail"))
```

```{r}
# Line plot: x = block (grouped by condition --> 2 lines), y = fail counts
clean_data %>% group_by(block, condition) %>% summarize(fail_count = sum(success == "fail"))
clean_data %>% group_by(block, condition) %>% summarize(fail_count = sum(success == "fail")) %>% 
  ggplot(aes(x = block, y = fail_count, color=condition)) +
  geom_point() +
  geom_line() +
  labs(
    title = "Count of trials with false response per block by condition", 
    x = "\n Block number", 
    y = "Fail count \n"
    ) +
  theme_linedraw() + 
  theme(plot.title = element_text(face = "bold"), legend.position = "right", legend.title = element_blank()) +
  scale_x_continuous(breaks = c(1:8))
```

```{r}
# Density plot: x = time, y = probability density (grouped by condition)
clean_data %>% group_by(condition) %>% filter(success == "success") %>% 
  ggplot(aes(x = log(time*1000), color=condition, fill=condition)) +
  geom_density(alpha=0.5) +
  labs(
    title = "Density of log-transformed trial times by condition", 
    x = "\n Trial time (log(ms))", 
    y = "\n"
    ) +
  theme_linedraw() + 
  theme(plot.title = element_text(face = "bold"), legend.position = "right", legend.title = element_blank())
```

```{r}
# Box plot: x = condition, y = RT
clean_data %>% group_by(condition) %>% filter(success == "success") %>% summarize(mean_time = mean(time)*1000)
clean_data %>% filter(success == "success") %>%
  ggplot(aes(x = condition, y = time*1000)) +
  geom_boxplot(outlier.shape = NA) +
  labs(
    title = "Mean and 25% and 75% trial time quantiles per condition", 
    x = NULL, 
    y = "Trial time (ms) \n"
    ) +
  theme_linedraw() + 
  theme(plot.title = element_text(face = "bold"), legend.position = "right", legend.title = element_blank()) +
  scale_y_continuous(limits = c(0, 6000)) # remove outliers from plot
  

# Perform the non-parametric Wilcoxon rank sum (with unpaired data as fail trials are excluded) test to compare group medians.
# Compare the results to the results of the corresponding t-tests (group mean comparison for normally distributed data).
wilcox.test(auditory_data$time, tactile_data$time, paired = FALSE)
t.test(auditory_data$time, tactile_data$time, paired = FALSE)
```

```{r}
# Line plot: x = block (grouped by condition --> 2 lines), y = median/mean RT
combined_data %>% group_by(block, condition) %>% summarize(mean_time = mean(time)*1000)
combined_data %>% group_by(block, condition) %>% summarize(mean_time = mean(time)*1000) %>% 
  ggplot(aes(x = block, y = mean_time, color=condition)) +
  geom_point() +
  geom_line() +
  labs(
    title = "Mean trial times per block by condition", 
    x = "\n Block number", 
    y = "Mean trial times (ms) \n"
    ) +
  theme_linedraw() + 
  theme(plot.title = element_text(face = "bold"), legend.position = "right", legend.title = element_blank()) +
  scale_x_continuous(breaks = c(1:8))

# test diffs between blocks
# tactile
wilcox.test(filter(combined_data, block == 1, condition == "tactile")$time, 
            filter(combined_data, block == 2, condition == "tactile")$time, paired = FALSE) # ***
wilcox.test(filter(combined_data, block == 3, condition == "tactile")$time, 
            filter(combined_data, block == 4, condition == "tactile")$time, paired = FALSE) # *

# auditory
wilcox.test(filter(combined_data, block == 1, condition == "auditory")$time, 
            filter(combined_data, block == 2, condition == "auditory")$time, paired = FALSE) # ***

# other comparisons yielded no significant differences
```

```{r}
# Barplot: y = RT, x = fruit position
pos_data <- clean_data # dummy
pos_data$location[pos_data$location == "rep_1"] = "1"
pos_data$location[pos_data$location == "rep_2"] = "2"
pos_data$location[pos_data$location == "rep_3"] = "3"
pos_data$location[pos_data$location == "rep_4"] = "4"
pos_data$location[pos_data$location == "rep_5"] = "5"
pos_data$location[pos_data$location == "rep_6"] = "6"
pos_data$location[pos_data$location == "rep_7"] = "7"
pos_data$location[pos_data$location == "rep_8"] = "8"
pos_data$location[pos_data$location == "rep_9"] = "9"

pos_data %>% filter(success == "success") %>% group_by(condition, location) %>% summarize(mean_time = mean(time)*1000)
pos_data %>% filter(success == "success") %>% group_by(condition, location) %>% summarize(mean_time = mean(time)*1000) %>%
  ggplot(aes(x = location, y = mean_time, fill = condition)) +
  geom_bar(stat="identity", position = "dodge") +
  labs(
    title = "Mean trial time per fruit location by condition", 
    x = "\n Fruit position", 
    y = "Mean trial time (ms) \n"
    ) +
  theme_linedraw() + 
  theme(plot.title = element_text(face = "bold", hjust = 0.5), 
    plot.subtitle = element_text(hjust = 0.5),
    legend.position = "right")


# mid (5) fastest as starting point is in front
# one-command positions up (2), left (4), right (6), down (8) are shorter than two-command positions
# diff between conditions for positions 1 and 3 (upper left and right) greater than for 7 and 9 (lower left and right)
# --> grasping at top shelf took longer, probably the chair was too low

# Could add test for each fruit position comparing conditions
# Could add comparison between upper left (1) and upper right (3) and/or lower left (7) and lower right (9)
```

```{r}
# Subset data by order
#data_tfirst <- clean_data[clean_data$participant_id == 1, ]
#data_tfirst$order <- "tactile_auditory"

data_afirst <- clean_data[clean_data$participant_id == 777
                             | clean_data$participant_id == 778, ]
data_afirst$order <- "auditory_tactile"

# bind the order data
order_data <- data_afirst # rbind(data_tfirst, data_afirst)

# Boxplot: x = condition, y = trial time, grouped by order
order_data %>% filter (success == "success") %>% group_by(condition, order) %>% summarize(mean_time = mean(time)*1000)
order_data %>% filter (success == "success") %>% 
  ggplot(aes(x = condition, y = time*1000, fill = order)) +
  geom_boxplot(outlier.shape = NA) +
  labs(
    title = "Mean trial times per condition by condition order", 
    x = NULL, 
    y = "Trial time (ms) \n"
    ) +
  theme_linedraw() + 
  theme(plot.title = element_text(face = "bold"), legend.position = "right") +
  scale_fill_discrete(labels = c("auditory first", "tactile first")) +
  scale_y_continuous(limits = c(0, 6000)) # remove outliers from plot

# test diffs for significance
#tactile_tfirst <- order_data %>% filter(success == "success", condition == "tactile", order == "tactile_auditory")
tactile_afirst <- order_data %>% filter(success == "success", condition == "tactile", order == "auditory_tactile")
#auditory_tfirst <- order_data %>% filter(success == "success", condition == "auditory", order == "tactile_auditory")
auditory_afirst <- order_data %>% filter(success == "success", condition == "auditory", order == "auditory_tactile")
#wilcox.test(tactile_tfirst$time, tactile_afirst$time, paired = FALSE) # ***
#wilcox.test(auditory_tfirst$time, auditory_afirst$time, paired = FALSE) # **
```


